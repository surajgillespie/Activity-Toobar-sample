define(function (require) {
    var activity = require("sugar-web/activity/activity");
    var icon = require("sugar-web/graphics/icon");
    var asdfssafd=require("sugar-web/graphics/palette");
    var datastore = require("sugar-web/datastore");
    var env=require("sugar-web/env");
    //var foo = require("sugar-web/foo");

    // Manipulate the DOM only when it is ready.
    require(['domReady!'], function (doc) {

        // Initialize the activity.
        activity.setup();
        var activityname=[];
        var actname=document.getElementById("aname");
        var datastoreObject = activity.getDatastoreObject();
        //var datastoreObject = new datastore.DatastoreObject();
        //var en=activity.environment();
        var stopButton = document.getElementById("stop-button");
        var actdescription = document.getElementById("descrip");
        var Title;
        var mdata;
        var flag=0;
        // Colorize the activity icon.
        var activityButton = document.getElementById("activity-button");
        activity.getXOColor(function (error, colors) {
            icon.colorize(activityButton, colors);
            
            /*
            datastoreObject.getMetadata(function (error, metadata) {
                console.log("in metadata");
                if(metadata==null)
                 {
                    console.log("metadata is null");
                    activityname=(metadata.activity).split('.');
                    actname.value=activityname[2];
                 }
                else
                 {
                    console.log("metadata is not null");
                    actname.value=metadata.title;
                 }   

                if(metadata.description==null)
                 actdescription.value="";
                else
                 actdescription.value=metadata.description;  
            });    */           
        });
        console.log("1");
        datastoreObject.getMetadata(function (error, metadata) {
            console.log("2");
            mdata=metadata;
            console.log(metadata);
            flag=1;
            abc("second");
              });
                
                abc("first");
                var Title;



                //console.log("inside get environment");
                function abc(time)
                {
                    console.log(time);
                if((mdata==null)||(mdata.title==null))
                {   console.log(mdata);
                    console.log("metadata is null");

                    datastoreObject.getMetadata(function (error, metadata) {
            
                    mdata=metadata;
                    console.log(metadata);
                    console.log("3");
                    });
                    if(mdata==null)
                        console.log("metadata is still null");
                    console.log("4");
                    env.getEnvironment(function (error, environment) {
                    var defaultTitle = (environment.bundleId).split('.');
                    Title=defaultTitle[2];
                    console.log(defaultTitle[2]);
                    datastoreObject.setMetadata({
                    "activity": environment.bundleId,
                    "activity_id": environment.activityId,
                    "title": Title
                    });
                    datastoreObject.save(function () {});
                    actname.value=Title;
                    });
                 }   
                else 
                {   

                    console.log(mdata);
                    if(mdata.title!=null)
                    {actname.value=mdata.title;
                     datastoreObject.setMetadata({
                    "activity": environment.bundleId,
                    "activity_id": environment.activityId,
                    "title": mdata.title
                    });
                    datastoreObject.save(function () {});   
                    }
                        /*
                    if(metadata.description!=null)
                        actdescription.value=metadata.description;
                    */
                }}
           
        console.log("5");
        stopButton.onclick = function () {
            activity.close();
         };


        actname.onblur=function() { 
                          
                console.log(actname.value);  
                datastoreObject.setMetadata({
                    
                    "title": actname.value
                });
            
           // datastoreObject.save(function () {});
            

            datastoreObject.getMetadata(function (error, metadata) {
            
            console.log(metadata);
             });
        };

        actdescription.onblur=function() { 
            
                console.log(actdescription.value);
                datastoreObject.setMetadata({
                    
                    "description": actdescription.value,
                });
            
            datastoreObject.save(function () {});
           
        };

    });

});
